---
title: >
  Twitter Weekly Analysis –
  `r format(params$week_start, '%Y‑%m‑%d')` to
  `r format(params$week_start + 6, '%Y‑%m‑%d')`
author: ""
date: "`r Sys.Date()`"

params:
  week_start: !r lubridate::floor_date(Sys.Date(), unit = "week", week_start = 1)

output:
  html_document:
    toc: true
    toc_float: true
    number_sections: false
  pdf_document:
    latex_engine: xelatex
    toc: true
---


```{r, echo = FALSE,warning = FALSE,message = FALSE}

knitr::opts_chunk$set(
  echo = FALSE,   # hide code
  warning = FALSE,
  message = FALSE
)


# Load essential libraries
library(tidyverse)
library(lubridate)
library(tidytext)
library(stringi)
library(knitr)
library(kableExtra)
library(forcats)
library(widyr)
library(ggraph)
library(igraph)
library(data.table)
library(sentimentr)
```

```{r}
Sys.setenv(
  SUPABASE_HOST = "aws-0-us-east-2.pooler.supabase.com",   # exactly as shown
  SUPABASE_PORT = "6543",                                  # ← pooled port
  SUPABASE_DB   = "postgres",
  SUPABASE_USER = "postgres.kubvrwnqmsmhwcuscvje",         # note project ref!
  SUPABASE_PWD  = "hfa-tgt8nkj1AVM9vqe"
)

con <- DBI::dbConnect(
  RPostgres::Postgres(),
  host     = Sys.getenv("SUPABASE_HOST"),
  port     = as.integer(Sys.getenv("SUPABASE_PORT")),
  dbname   = Sys.getenv("SUPABASE_DB"),
  user     = Sys.getenv("SUPABASE_USER"),
  password = Sys.getenv("SUPABASE_PWD"),
  sslmode  = "require"
)

twitter_raw2 <- DBI::dbReadTable(con, "twitter_raw")

# ── 1. map handle → canonical user‑id ───────────────────────────
main_ids <- tibble::tribble(
  ~username,            ~main_id,
  "weave_db",           "1206153294680403968",
  "OdyseeTeam",         "1280241715987660801",
  "ardriveapp",         "1293193263579635712",
  "redstone_defi",      "1294053547630362630",
  "everpay_io",         "1334504432973848577",
  "decentlandlabs",     "1352388512788656136",
  "KYVENetwork",        "136377177683878784",
  "onlyarweave",        "1393171138436534272",
  "ar_io_network",      "1468980765211955205",
  "Permaswap",          "1496714415231717380",
  "communitylabs",      "1548502833401516032",
  "usewander",          "1559946771115163651",
  "apus_network",       "1569621659468054528",
  "fwdresearch",        "1573616135651545088",
  "perma_dao",          "1595075970309857280",
  "Copus_io",           "1610731228130312194",
  "basejumpxyz",        "1612781645588742145",
  "AnyoneFDN",          "1626376419268784130",
  "arweaveindia",       "1670147900033343489",
  "useload",            "1734941279379759105",
  "protocolland",       "1737805485326401536",
  "aoTheComputer",      "1750584639385939968",
  "ArweaveOasis",       "1750723327315030016",
  "aox_xyz",            "1751903735318720512",
  "astrousd",           "1761104764899606528",
  "PerplexFi",          "1775862139980226560",
  "autonomous_af",      "1777500373378322432",
  "Liquid_Ops",         "1795772412396507136",
  "ar_aostore",         "1797632049202794496",
  "FusionFiPro",        "1865790600462921728",
  "vela_ventures",      "1869466343000444928",
  "beaconwallet",       "1879152602681585664",
  "VentoSwap",          "1889714966321893376",
  "permawebjournal",    "1901592191065300993",
  "Botega_AF",          "1902521779161292800",
  "samecwilliams",      "409642632",
  "TateBerenbaum",      "801518825690824707",
  "ArweaveEco",         "892752981736779776",
  "outprog_ar",         "2250655424",
  "HyMatrixOrg",        "1948283615248568320",
  "EverVisionLabs",     "1742119960535789568"
)


# tweets_raw is the data frame you showed
tweets_tagged <- twitter_raw2 %>%                         # ← your df
  left_join(main_ids, by = "username") %>%
  # ── 2. classify rows ──────────────────────────────────────────
  mutate(
    is_rt_text = str_detect(text, "^RT @"),
    
    post_type = case_when(
      is_rt_text                                   ~ "retweet",
      user_id == main_id & is_rt_text == FALSE &
        str_detect(text, "https://t.co")           ~ "quote",      # rough proxy
      user_id == main_id                           ~ "original",
      TRUE                                         ~ "other"
    )
  )
```



```{r}

# 3) Add day, month, year, etc. for easy filtering
df <- tweets_tagged |>
  mutate(
    day      = as.Date(date),
    month    = lubridate::month(date),
    year     = lubridate::year(date),
    hour     = lubridate::hour(date),
    weekday  = lubridate::wday(date,
                               label  = TRUE,   # Mon, Tue, …
                               abbr   = FALSE,  # full names
                               locale = "en_US")) %>% 
  filter(post_type!="other")

# 3) Add day, month, year, etc. for easy filtering
# ── Define the 7‑day window -----------------------------------------------
week_start <- as.Date(params$week_start)           # Monday
week_end   <- week_start + lubridate::days(6)      # Sunday

df_week <- df %>%                                  # df comes from your earlier mutate()
  filter(date >= week_start,
         date <= week_end,
         post_type != "other") %>%
  mutate(
    week_day = lubridate::wday(date,
                               label  = TRUE, abbr = FALSE,
                               locale = "en_US"),
    week_hour = lubridate::hour(date)
  )

if (nrow(df_week) == 0){
  cat("\n\n### No tweets between",
      format(week_start, "%Y‑%m‑%d"), "and",
      format(week_end,   "%Y‑%m‑%d"), "– nothing to report.\n\n")
  knitr::knit_exit()
}

```


# Sentiment Analysis

```{r}
df_week1 <- df_week %>%
    as_tibble() %>%
    mutate(text = str_replace_all(text, "&quot;|&#x2F;", "'"),    
           text = str_replace_all(text, "&#x2F;", "/"),           
           text = str_replace_all(text, "<a(.*?)>", " "),          
           text = str_replace_all(text, "&gt;|&lt;", " "),        
           text = str_replace_all(text, "<[^>]*>", " "),
           text = str_replace_all(text,"http.*\\s*"," "),
           text = str_replace_all(text,"\\031","'"),
           text = str_replace_all(text,"\\[",""),
           text = str_replace_all(text,"\\[",""),
           text = str_replace_all(text,"\\]",""),
           text = str_replace_all(text,"\\(",""),
           text = str_replace_all(text,"\\)",""),
           text = str_replace_all(text,"\\*",""),
           text = str_replace_all(text,'"',""),
           text = str_replace_all(text,"'",""),
           text = str_replace_all(text,"~",""),
           text = str_replace_all(text,"#",""),
           text = str_replace_all(text,"\\n"," "),
           text = str_replace_all(text,"\\034",""),
           text = str_replace_all(text,"\\035",""),
           text = str_replace_all(text,"\\tI",""),
           text = str_replace_all(text,"_",""),
           text = str_replace_all(text,"\\\\"," "),
           text = str_replace_all(text,"a°",""),
           text = str_replace_all(text,"<",""),
           text = str_replace_all(text,">",""),
           text = str_replace_all(text,"&amp;",""),
           text = str_replace_all(text,"\\024",""),
           text = str_replace_all(text,"-",""),
           text = str_replace_all(text,"U\\+0096",""),
           text = str_replace_all(text,"\\033","")
           )   

df_week1<-df_week1 %>% mutate(words=str_count(text,"\\w+")) %>% as_tibble() %>%filter(words>5)

```

```{r}
library(sentimentr)
```


```{r}
polarity_dt = lexicon::hash_sentiment_jockers_rinker

sentiment_key <- lexicon::hash_sentiment_jockers_rinker %>% 
  dplyr::filter(!x %in% c("damn","damned","dammit","goddamn","goddamned","hell","hells","heck","jail","spoiler","goblin","hot","shot","fuck","fucked","fucks","mindfuck"))
```



```{r}

custom_words<-data.table(
  x = c("hot" ),
  y = c(1),
  key = "x")

sentiment_key2<-rbind(polarity_dt,custom_words)

sentiment_key2<-update_key(polarity_dt, x = data.frame(x = c("hot"), y = c(1)))

```



```{r}
mycomment <- get_sentences(df_week1$text)

sentiments3<-sentiment_by(mycomment,polarity_dt = sentiment_key2)
```

```{r}

df_week1 <- df_week1 %>%
  mutate(element_id = seq_len(nrow(df_week1)))

```

```{r}
df_week1<-inner_join(sentiments3,df_week1)
```
```{r}

df_week1 %>%
  ggplot(aes(x = "", y = ave_sentiment)) +
  geom_boxplot(fill = "#2C3E50", color = "black", width = 0.3, outlier.color = "red", outlier.shape = 16) +
  labs(
    title = "Distribution of Average Sentiment Scores",
    y = "Average Sentiment",
    x = NULL
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    axis.title.y = element_text(size = 12),
    axis.text = element_text(size = 10),
    panel.grid.major.y = element_line(color = "gray90"),
    panel.grid.major.x = element_blank()
  )+coord_flip()

```


```{r}
# Classify sentiment
df_week1 <- df_week1 %>%
  mutate(sentiment = case_when(
    ave_sentiment > 0.05 ~ "positive",
    ave_sentiment < -0.05 ~ "negative",
    TRUE ~ "neutral"
  ))

# Group by date (day) instead of month
daily_sentiment <- df_week1 %>%
  group_by(day, sentiment) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(day) %>%
  mutate(percent = count / sum(count) * 100)

# Plot
ggplot(daily_sentiment, aes(x = day, y = percent, color = sentiment)) +
  geom_line() +
  labs(
    title = "Daily Sentiment Trend on Twitter",
    x = "Date",
    y = "Percentage of Tweets",
    color = "Sentiment"
  ) +
  scale_color_manual(values = c("negative" = "red", "neutral" = "gray", "positive" = "blue")) +
  theme_minimal(base_size = 14)
```


```{r}
# Overall sentiment count
overall_sentiment <- df_week1 %>%
  count(sentiment) %>%
  mutate(percent = n / sum(n) * 100)

# Plot
ggplot(overall_sentiment, aes(x = sentiment, y = percent, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  scale_fill_manual(values = c("negative" = "tomato", "neutral" = "khaki", "positive" = "skyblue")) +
  labs(
    title = "Overall Sentiment Distribution on Twitter",
    x = "Sentiment Type",
    y = "Percentage of Tweets"
  ) +
  theme_minimal(base_size = 14)

```

```{r}
# Count sentiment within each post type and calculate percentage
sentiment_by_type <- df_week1 %>%
  count(post_type, sentiment) %>%
  group_by(post_type) %>%
  mutate(percent = n / sum(n) * 100) %>%
  ungroup()

# Plot
ggplot(sentiment_by_type, aes(x = sentiment, y = percent, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ post_type) +
  scale_fill_manual(values = c("negative" = "tomato", "neutral" = "khaki", "positive" = "skyblue")) +
  labs(
    title = "Sentiment Distribution by Tweet Type",
    x = "Sentiment Type",
    y = "Percentage of Tweets"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    axis.title = element_text(face = "bold")
  )

```





```{r}
# Calculate average sentiment by day
daily_avg_sentiment <- df_week1 %>%
  group_by(day) %>%
  summarise(avg_sentiment = mean(ave_sentiment, na.rm = TRUE))

# Plot
ggplot(daily_avg_sentiment, aes(x = day, y = avg_sentiment)) +
  geom_line(color = "steelblue") +
  labs(
    title = "Average Sentiment Score by Day",
    x = "Date",
    y = "Average Sentiment") +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    axis.title = element_text(face = "bold")
  )
```


```{r}
# Calculate daily average sentiment by post type
daily_sentiment_by_type <- df_week1 %>%
  group_by(day, post_type) %>%
  summarise(avg_sentiment = mean(ave_sentiment, na.rm = TRUE), .groups = "drop")

# Plot
ggplot(daily_sentiment_by_type, aes(x = day, y = avg_sentiment, color = post_type)) +
  geom_line() +
  labs(
    title = "Average Sentiment Score by Day and Post Type",
    x = "Date",
    y = "Average Sentiment Score",
    color = "Post Type"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    axis.title = element_text(face = "bold"),
    legend.position = "top"
  )

```



```{r}

nrc_key <- lexicon::hash_nrc_emotions %>% 
  dplyr::filter(
  emotion %in% c('trust',"anger","anticipation","fear","sadness","surprise","disgust","joy")) %>% 
  dplyr::filter(!token %in% c("damn","damned","dammit","goddamn","goddamned","peach","curse","cursed","hell","hells","heck","fuck","fucked","fucks","mindfuck","punch","money","insane","crazy","shit")) %>% filter(emotion!="fear"|token!="cringe") %>% 
filter(emotion!="sadness"|token!="cringe") 
```


```{r}
emotions2<-emotion_by(df_week1$text,emotion_dt =nrc_key)


df_week2<-inner_join(df_week1,emotions2,by="element_id")

```


```{r}
x<-df_week2%>% pivot_wider(names_from = emotion_type, values_from = ave_emotion) %>%
    mutate(across(c(anger:trust_negated), ~ifelse(is.na(.x), 0,.))) %>% mutate(anger=anger-anger_negated,anticipation=anticipation-anticipation_negated,disgust=disgust-disgust_negated,fear=fear-fear_negated,joy=joy-joy_negated,sadness=sadness-sadness_negated,surprise=surprise-surprise_negated,trust=trust-trust_negated) %>% pivot_longer(cols = anger:trust_negated, names_to = "emotion_type", values_to = "ave_emotion")%>%
  group_by(emotion_type) %>% 
  summarize(ave_emotion=mean(ave_emotion)) %>% pivot_wider(names_from = emotion_type, values_from = ave_emotion) %>% arrange(desc(anger))

y<-df_week2%>% pivot_wider(names_from = emotion_type, values_from = ave_emotion) %>%
    mutate(across(c(anger:trust_negated), ~ifelse(is.na(.x), 0,.))) %>% mutate(anger=anger-anger_negated,anticipation=anticipation-anticipation_negated,disgust=disgust-disgust_negated,fear=fear-fear_negated,joy=joy-joy_negated,sadness=sadness-sadness_negated,surprise=surprise-surprise_negated,trust=trust-trust_negated) %>% pivot_longer(cols = anger:trust_negated, names_to = "emotion_type", values_to = "ave_emotion")
```





```{r}
# Scatter plot: Sentiment Polarity vs Engagement Rate
ggplot(y, aes(x = (ave_sentiment), y = log(engagement_rate))) +
  geom_point(alpha = 0.6, color = "#2C3E50") +  # semi-transparent points
  geom_smooth(method = "lm", se = TRUE, color = "#E74C3C", linetype = "dashed") + # regression line
  labs(
    title = "Relationship between Sentiment Polarity and Engagement Rate",
    x = "Average Sentiment Polarity",
    y = "Engagement Rate"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    axis.title = element_text(face = "bold")
  )
```

## Emotion Analysis

```{r}

# 1. Filter: Remove negated emotions AND ave_emotion <= 0
y_filtered <- y %>%
  filter(!str_detect(emotion_type, "negated$")) %>%
  filter(ave_emotion > 0)

# 2. Daily trend
daily_emotion <- y_filtered %>%
  group_by(day, emotion_type) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(day) %>%
  mutate(percent = count / sum(count) * 100)

# 3. Plot
ggplot(daily_emotion, aes(x = day, y = percent, color = emotion_type)) +
  geom_line(size = 0.5) +
  labs(
    title = "Daily Emotion Trend",
    x = "Date",
    y = "Percentage of Tweets",
    color = "Emotion"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    axis.title = element_text(face = "bold")
  )

```





```{r}
# 4. Overall
overall_emotion <- y_filtered %>%
  count(emotion_type) %>%
  mutate(percent = n / sum(n) * 100)

# 5. Plot
ggplot(overall_emotion, aes(x = reorder(emotion_type, percent), y = percent, fill = emotion_type)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  labs(
    title = "Overall Emotion Distribution",
    x = "Emotion",
    y = "Percentage of Tweets"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    axis.title = element_text(face = "bold")
  )

```


```{r}
# 6. Emotion per post type
emotion_by_post_type <- y_filtered %>%
  count(post_type, emotion_type) %>%
  group_by(post_type) %>%
  mutate(percent = n / sum(n) * 100) %>%
  ungroup()


# 7. Plot
ggplot(emotion_by_post_type, aes(x = emotion_type, y = percent, fill = emotion_type)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ post_type) +
  labs(
    title = "Emotion Distribution by Tweet Type",
    x = "Emotion",
    y = "Percentage of Tweets"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    axis.title = element_text(face = "bold"),
    strip.text = element_text(face = "bold")
  ) +
  coord_flip()

```


















